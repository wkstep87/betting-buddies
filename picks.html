<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Picks ¬∑ Betting Buddies</title>

  <!-- Icons / PWA (safe if present; harmless if missing locally) -->
  <link rel="manifest" href="/site.webmanifest" />
  <link rel="icon" href="/favicon.ico" sizes="any" />
  <link rel="icon" type="image/png" href="/assets/icons/favicon-32.png" sizes="32x32" />
  <link rel="icon" type="image/png" href="/assets/icons/favicon-16.png" sizes="16x16" />
  <link rel="apple-touch-icon" href="/assets/icons/apple-touch-icon-180.png" sizes="180x180" />
  <meta name="theme-color" content="#0B1220" />

  <link rel="stylesheet" href="assets/styles.css" />

  <!-- Order matters: lib -> config -> helpers -> page -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script src="assets/config.js"></script>
  <script src="assets/supabase.js"></script>
  <script src="assets/common.js"></script>

  <style>
    .kickoff-tag{opacity:.8;font-size:12px;margin-bottom:4px}
    @media (max-width:768px){.hide-mobile{display:none!important}}
    .toolbar { display:flex; gap:16px; align-items:center; flex-wrap:wrap; }
    .toolbar label { font-weight:500; }
    .toolbar .select { min-width:110px; }
    .brand-logo { height:22px; }
    .matchup-grid{display:grid;grid-template-columns:1fr auto 1fr;gap:8px;align-items:center}
    .matchup-away,.matchup-home{display:flex;align-items:center;gap:6px}
    .bb-logo-btn{background:transparent;border:0;padding:0;display:inline-flex;align-items:center;cursor:pointer}
    .bb-logo-btn img{width:22px;height:22px;border-radius:50%;object-fit:contain;background:#0a0a0a}
    .pick-select.status-won{background:#0a3320;border-color:#1e7f4d}
    .pick-select.status-lost{background:#381a1a;border-color:#a33}
    .pick-select.status-push{background:#2e2e2e;border-color:#777}
    .badge.frozen{background:#0b2a46;border:1px solid #3477ad}
    .partial-note{background:#2b1f00;border:1px solid #7a5b00;padding:8px;border-radius:6px}
    .nav .badge { margin-left:auto }
  </style>
</head>

<body>
<header>
  <div class="nav">
    <div class="brand">
      <img src="assets/BB1_clean_transparent_optimized.png" alt="Betting Buddies" class="brand-logo">
    </div>

    <nav class="nav-links">
      <a href="picks.html" aria-current="page">Picks</a>
      <a href="group.html">Group</a>
      <a href="standings.html">Standings</a>
      <a href="bankroll.html">Bankroll</a>
    </nav>

    <span class="badge">Season 2025</span>
  </div>
</header>

<main>
  <div class="card">
<div class="toolbar">
  <div class="filters">
    <label class="user">User:
      <input id="username" type="text" style="width:120px" readonly />
    </label>

    <label class="week">Week:
      <select id="week-select" class="select"></select>
    </label>

    <label class="sort">Sort:
      <select id="sortMode" class="select">
        <option value="time" selected>Kickoff Time</option>
        <option value="conf">Confidence</option>
      </select>
    </label>
  </div>


      <!-- Admin controls (shown only for Will) -->
      <div style="margin-left:auto; display:flex; gap:8px; flex-wrap:wrap;">
        <button class="btn admin" id="btn-pull-scores"  style="display:none" title="Pull latest scores and re-grade now">üîÑ Pull Scores</button>
        <button class="btn admin" id="btn-default-week" style="display:none" title="Set CURRENT week as default">‚≠ê Default Week</button>
        <button class="btn admin" id="btn-freeze-week"  style="display:none" title="Freeze all lines for this week">‚ùÑÔ∏è Freeze Week</button>
        <button class="btn admin" id="btn-lock"        style="display:none" title="Lock this week">üîí Lock Week</button>
        <button class="btn admin" id="btn-unlock"      style="display:none" title="Unlock this week">üîì Unlock Week</button>
      </div>
    </div>

    <div class="table-wrap">
      <table class="table picks">
        <thead>
          <tr>
            <th>Matchup</th>
            <th>Home Spread</th>
            <th>Your Pick</th>
            <th>Confidence</th>
          </tr>
        </thead>
        <tbody id="picks-body"></tbody>
      </table>
    </div>

    <div id="partialWarning" class="partial-note" style="display:none; margin:10px 0;">
      Your slate is partially complete. <span id="partialCount"></span>
    </div>

    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:20px;">
      <div>Confidence starts at 16 and descends; lowest numbers removed if fewer games.</div>
      <div>
        <button id="savePicksBtn" class="btn btn-primary">Save Picks</button>
        <span id="saveStatus" style="margin-left:10px; display:none;"></span>
      </div>
    </div>
  </div>
</main>

<div class="toast"></div>

<!-- Confirm Modal -->
<div id="confirmModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:1000;">
  <div style="max-width:640px; margin:80px auto; background:#111; color:#eee; border-radius:8px; padding:16px;">
    <h3 style="margin:0 0 10px;">Confirm Picks ‚Äî Top 5 by Confidence</h3>
    <div id="confirmSummary" style="font-size:14px; opacity:.9; margin-bottom:10px;"></div>
    <div id="top5List" style="border:1px solid #333; border-radius:6px; padding:8px; max-height:300px; overflow:auto;"></div>
    <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:12px;">
      <button id="cancelConfirmBtn" class="btn">Cancel</button>
      <button id="confirmSaveBtn" class="btn btn-primary">Confirm</button>
    </div>
  </div>
</div>

<!-- Research modal (Phase 1 UI kept) -->
<style>
  #researchBackdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:1100}
  .bb-modal{max-width:800px;margin:64px auto;background:#111;color:#eee;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.55);overflow:hidden}
  .bb-modal header{display:flex;align-items:center;gap:12px;padding:12px 14px;background:#0f0f0f;border-bottom:1px solid #222}
  .bb-modal .body{padding:12px 14px}
  .bb-team-city{opacity:.85;font-size:14px}
  .bb-team-nick{font-size:22px;font-weight:700;line-height:1.1}
  .bb-team-stack{display:flex;flex-direction:column}
  .bb-logo-slot img{width:40px;height:40px;border-radius:50%;object-fit:contain;background:#0a0a0a}
  .bb-card{border:1px solid #2a2a2a;border-radius:8px;padding:10px}
  .bb-card h4{margin:0 0 6px;font-size:14px;opacity:.9}
  .bb-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .bb-row{display:flex;justify-content:space-between;margin:4px 0}
  .bb-row .l{opacity:.9}
  .bb-row .r{font-weight:600}
  .bb-close{background:#1f2937;border:1px solid #374151;color:#e5e7eb;border-radius:8px;padding:6px 10px;cursor:pointer}
  @media (max-width:600px){
    .bb-modal{position:fixed;top:0;left:0;margin:0;max-width:560px;width:calc(100vw - 12px);box-sizing:border-box}
    .bb-grid{grid-template-columns:1fr}
  }
</style>
<div id="researchBackdrop">
  <div class="bb-modal">
    <header>
      <div id="bbResearchLogoSlot" class="bb-logo-slot"></div>
      <div class="bb-team-stack">
        <div id="bbTeamCity" class="bb-team-city"></div>
        <div id="bbTeamNick" class="bb-team-nick"></div>
      </div>
      <div style="margin-left:auto"><button class="bb-close" id="bbResearchClose">Close</button></div>
    </header>
    <div class="body">
      <div style="opacity:.9;margin-bottom:8px">Week <span id="bbWeek"></span></div>
      <div class="bb-card" style="margin-top:12px">
        <h4>This Week</h4>
        <div class="bb-row"><span class="l">Opponent</span><span class="r" id="bbOpponent">‚Äî</span></div>
        <div class="bb-row"><span class="l">Line</span><span class="r" id="bbLine">‚Äî</span></div>
        <div class="bb-row"><span class="l">Kickoff</span><span class="r" id="bbKick">‚Äî</span></div>
      </div>
    </div>
  </div>
</div>

<script>
/* -------------------------------------------------------------
   Page state
------------------------------------------------------------- */
let CURRENT_WEEK = 1;
let locked = false;
let games = [];
let myPicks = {};               // { [gameId]: { team, confidence, ... } }
let usedConfidence = new Set(); // Set<number>
const IS_MOBILE = window.matchMedia('(max-width: 768px)');

/* -------------------------------------------------------------
   Helpers
------------------------------------------------------------- */
function setUsername(u){
  USERNAME = (u && u.trim()) || '';
  localStorage.setItem('username', USERNAME);
  const box = document.getElementById('username');
  if (box) box.value = USERNAME;

  const isAdmin = (USERNAME === 'Will');
  document.getElementById('btn-lock').style.display         = isAdmin ? 'inline-block' : 'none';
  document.getElementById('btn-unlock').style.display       = isAdmin ? 'inline-block' : 'none';
  document.getElementById('btn-freeze-week').style.display  = isAdmin ? 'inline-block' : 'none';
  document.getElementById('btn-default-week').style.display = isAdmin ? 'inline-block' : 'none';
  document.getElementById('btn-pull-scores').style.display  = isAdmin ? 'inline-block' : 'none';
}

function confPoolFor(n){
  // 16 descending; truncated by number of games
  return Array.from({length:n},(_,i)=>16-i);
}

function kickoffText(ts){
  if(!ts) return '';
  const dt = new Date(ts);
  return dt.toLocaleString('en-US',{weekday:'short',hour:'numeric',minute:'2-digit'});
}

function updatePartialBanner(){
  const rows = Array.from(document.querySelectorAll('tr[data-game-id]'));
  const done = rows.filter(r=>{
    const teamSel = r.querySelector('select.team-select');
    const confSel = r.querySelector('select.conf-select');
    return (teamSel?.value || confSel?.value);
  }).length;
  const total = rows.length;
  const started = rows.filter(r=>{
    const teamSel = r.querySelector('select.team-select');
    const confSel = r.querySelector('select.conf-select');
    return (teamSel?.value || confSel?.value);
  }).length;

  const el = document.getElementById('partialWarning');
  const label = document.getElementById('partialCount');
  const complete = Object.values(myPicks).filter(p => p.team || p.confidence != null).length;

  if (complete>0 && complete<total){
    el.style.display='block';
    if(label) label.textContent = `${complete} of ${total} selections started`;
  } else {
    el.style.display='none';
  }
}

function applyLabelMode(sel, mode){ // 'full' | 'abbr'
  Array.from(sel.options).forEach(opt=>{
    const full = opt.dataset.full || opt.textContent;
    const abbr = opt.dataset.abbr || full;
    opt.textContent = (mode==='abbr') ? abbr : full;
  });
}

/* -------------------------------------------------------------
   Save flow
------------------------------------------------------------- */
function buildTop5(){
  const rows = Array.from(document.querySelectorAll('tr[data-game-id]'));
  const selections = rows.map(r=>{
    const game_id = Number(r.dataset.gameId || r.getAttribute('data-game-id'));
    const home = r.getAttribute('data-home');
    const away = r.getAttribute('data-away');
    const spreadRaw = r.getAttribute('data-spread');
    const spread = (spreadRaw!==null && spreadRaw!=='' && !Number.isNaN(Number(spreadRaw))) ? Number(spreadRaw) : null;

    const teamEl = r.querySelector('select.team-select');
    const team = (teamEl && teamEl.value) ? teamEl.value : null;

    const confEl = r.querySelector('select.conf-select');
    const confStr = confEl ? confEl.value : '';
    const confidence = confStr === '' ? null : Number(confStr);

    return { game_id, home, away, spread, team, confidence };
  });

  // top 5 by confidence (nulls go last)
  const sorted = selections
    .slice()
    .sort((a,b)=>{
      const ac = a.confidence ?? -Infinity;
      const bc = b.confidence ?? -Infinity;
      return bc - ac;
    })
    .slice(0, Math.min(5, selections.length));

  return { selections, top5: sorted };
}

function renderTop5Dialog(){
  const { selections, top5 } = buildTop5();
  const summary = document.getElementById('confirmSummary');
  if(summary){
    const week = CURRENT_WEEK;
    const complete = selections.filter(s => (s.team || s.confidence!=null)).length;
    const total = selections.length;
    const started = selections.filter(s => (s.team || s.confidence!=null)).length;
    summary.innerHTML =
`Week: ${week}<br/>
Progress: ${complete}/${total} complete (${started} started)<br/>
Previewing: Top 5 of your completed picks`;
  }

  const list = document.getElementById('top5List');
  list.innerHTML='';
  top5.forEach(item=>{
    const opponent = item.team === item.home ? item.away : item.home;
    const vsAt = item.team === item.home ? 'vs' : '@';
    const spreadTxt = (item.spread==null) ? ' ' : ` ¬∑ Spread: ${item.spread>0 ? '+'+item.spread : item.spread}`;
    const row = document.createElement('div');
    row.style.padding='8px';
    row.style.borderBottom='1px solid #222';
    row.innerHTML = `
      <div><strong>${item.team || '(no team yet)'}</strong> ${vsAt} ${opponent}${spreadTxt}</div>
      <div style="opacity:.9">Confidence: ${item.confidence ?? '‚Äî'}</div>`;
    list.appendChild(row);
  });
}

function openConfirmModal(){
  renderTop5Dialog();
  document.getElementById('confirmModal').style.display='block';
}
function closeConfirmModal(){
  document.getElementById('confirmModal').style.display='none';
}

async function doSave(){
  // Persist only rows that have either a team OR a confidence set.
  const rows = Array.from(document.querySelectorAll('tr[data-game-id]'));
  const week = CURRENT_WEEK;
  const username = localStorage.getItem('username') || window.CONFIG.USERNAME || '';
  const season = window.CONFIG.SEASON_NUMBER || 2025;

  const payload = rows
    .map(r=>{
      const game_id = Number(r.getAttribute('data-game-id'));
      const teamSel = r.querySelector('select.team-select');
      const confSel = r.querySelector('select.conf-select');
      const team = teamSel && teamSel.value ? teamSel.value : null;
      const confStr = confSel ? confSel.value : '';
      const confidence = confStr === '' ? null : Number(confStr);
      return { username, season, week, game_id, team, confidence };
    })
    .filter(x => x.team || x.confidence != null);

  const btn = document.getElementById('confirmSaveBtn');
  btn.disabled = true; btn.textContent = 'Saving...';
  try{
    await sbUpsertPicks(payload);
    closeConfirmModal();
    if (typeof showToast==='function') showToast('Saved!');
  }catch(e){
    console.error(e);
    if (typeof showToast==='function') showToast('Save failed.');
  }finally{
    btn.disabled = false; btn.textContent = 'Confirm';
  }
}

function initSaveFlow(){
  document.getElementById('savePicksBtn').onclick = openConfirmModal;
  document.getElementById('cancelConfirmBtn').onclick = closeConfirmModal;
  document.getElementById('confirmSaveBtn').onclick = doSave;
}

/* -------------------------------------------------------------
   Render
------------------------------------------------------------- */
function tintPickCell(selTeam, g){
  selTeam.classList.remove('status-won','status-push','status-lost');

  const mp = myPicks[g.id] || {};
  const team = (mp.team ?? selTeam.value ?? '').toString();
  if (!team) return;

  const gameFinal = mp.game_final === true;
  const winnerATS = mp.game_winner_ats;

  if (gameFinal && winnerATS) {
    const isHome = team.toLowerCase() === g.home.toLowerCase();
    const isAway = team.toLowerCase() === g.away.toLowerCase();
    const pickSide = isHome ? 'HOME' : (isAway ? 'AWAY' : 'UNKNOWN');

    if (winnerATS === 'PUSH') selTeam.classList.add('status-push');
    else if (pickSide === winnerATS) selTeam.classList.add('status-won');
    else selTeam.classList.add('status-lost');
    return;
  }

  if (g.home_score == null || g.away_score == null) return;

  const hs = Number(g.home_score);
  const as = Number(g.away_score);
  const ln = Number((g.spread_frozen ?? g.spread));
  if (!Number.isFinite(hs) || !Number.isFinite(as) || !Number.isFinite(ln)) return;

  const isHome = team.toLowerCase() === g.home.toLowerCase();
  const isAway = team.toLowerCase() === g.away.toLowerCase();
  const pickSide = isHome ? 'HOME' : (isAway ? 'AWAY' : 'UNKNOWN');

  const adjHome = hs + ln;
  let leader = 'PUSH';
  if (adjHome > as) leader = 'HOME';
  else if (adjHome < as) leader = 'AWAY';

  if (leader === 'PUSH') selTeam.classList.add('status-push');
  else if (pickSide !== 'UNKNOWN') selTeam.classList.add(pickSide === leader ? 'status-won' : 'status-lost');
}

function rowHtml(g, confPool){
  const line = (g.spread_frozen ?? g.spread);
  const lineTxt = (line==null || line==='') ? '' : (Number(line)>0 ? '+'+Number(line) : String(Number(line)));

  const my = myPicks[g.id] || {};
  const curTeam = my.team || '';
  const curConf = (my.confidence==null ? '' : String(my.confidence));

  const confOpts = ['<option value="">‚Äî</option>']
    .concat(confPool.map(n => `<option value="${n}">${n}</option>`))
    .join('');

  const awayAbbr = TEAM_LOGOS[g.away] || g.away.slice(0,3).toUpperCase();
  const homeAbbr = TEAM_LOGOS[g.home] || g.home.slice(0,3).toUpperCase();

  return `
  <tr data-game-id="${g.id}" data-home="${g.home}" data-away="${g.away}" data-spread="${line ?? ''}" data-commence="${new Date(g.commence_time).getTime()||0}">
    <td>
      <div class="kickoff-tag hide-mobile">${kickoffText(g.commence_time)}</div>
      <div class="matchup-grid">
        <div class="matchup-away">
          <span class="team-name">${g.away}</span>
          <button type="button" class="bb-logo-btn" data-research="away">${makeTeamLogoOnly(g.away).outerHTML}</button>
        </div>
        <div style="text-align:center;">@</div>
        <div class="matchup-home">
          <button type="button" class="bb-logo-btn" data-research="home">${makeTeamLogoOnly(g.home).outerHTML}</button>
          <span class="team-name">${g.home}</span>
        </div>
      </div>
    </td>
    <td>
      <span class="badge ${g.spread_is_frozen ? 'frozen':''}" data-freeze="${g.id}">DK ${lineTxt}</span>
    </td>
    <td>
      <select class="select team-select pick-select">
        <option value="">‚Äî</option>
        <option value="${g.away}" data-full="${g.away}" data-abbr="${awayAbbr}">${IS_MOBILE.matches ? awayAbbr : g.away}</option>
        <option value="${g.home}" data-full="${g.home}" data-abbr="${homeAbbr}">${IS_MOBILE.matches ? homeAbbr : g.home}</option>
      </select>
    </td>
    <td>
      <select class="select conf-select" id="conf-${g.id}">
        ${confOpts}
      </select>
    </td>
  </tr>`;
}

function attachRowHandlers(tr, g){
  const teamSel = tr.querySelector('select.team-select');
  const confSel = tr.querySelector('select.conf-select');

  teamSel.value = myPicks[g.id]?.team || '';
  confSel.value = myPicks[g.id]?.confidence==null ? '' : String(myPicks[g.id].confidence);
  teamSel.disabled = confSel.disabled = !!locked;

  // abbr/full swap on focus/blur (mobile)
  teamSel.addEventListener('focus',()=>{
    Array.from(teamSel.options).forEach(opt=>{ if(opt.dataset.full) opt.textContent = opt.dataset.full; });
  });
  teamSel.addEventListener('blur',()=>{
    Array.from(teamSel.options).forEach(opt=>{
      if (opt.dataset.abbr && IS_MOBILE.matches) opt.textContent = opt.dataset.abbr;
      else if (opt.dataset.full) opt.textContent = opt.dataset.full;
    });
  });

  // team change ‚Äî allow saving team without confidence
  teamSel.addEventListener('change', async ()=>{
    try{
      const username = localStorage.getItem('username') || window.CONFIG.USERNAME || '';
      const season = window.CONFIG.SEASON_NUMBER || 2025;
      const team = teamSel.value || null;
      const confStr = confSel.value || '';
      const confidence = confStr==='' ? null : Number(confStr);

      await sbUpsertPicks([{ username, season, week: CURRENT_WEEK, game_id: g.id, team, confidence }]);
      myPicks[g.id] = { ...(myPicks[g.id]||{}), team, confidence };
      tintPickCell(teamSel, g);
      updatePartialBanner();
      if (typeof showToast==='function') showToast('Saved team.');
    }catch(e){ console.error('team save failed', e); }
  });

  // confidence change ‚Äî allow saving confidence without team
  confSel.addEventListener('change', async ()=>{
    try{
      const username = localStorage.getItem('username') || window.CONFIG.USERNAME || '';
      const season = window.CONFIG.SEASON_NUMBER || 2025;
      const confStr = confSel.value || '';
      const confidence = confStr==='' ? null : Number(confStr);
      const team = teamSel.value || null;

      await sbUpsertPicks([{ username, season, week: CURRENT_WEEK, game_id: g.id, team, confidence }]);
      myPicks[g.id] = { ...(myPicks[g.id]||{}), team, confidence };
      tintPickCell(teamSel, g);
      updatePartialBanner();
      if (typeof showToast==='function') showToast('Saved confidence.');
    }catch(e){ console.error('confidence save failed', e); }
  });

  // research click (logo buttons)
  tr.querySelectorAll('[data-research]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const who = btn.getAttribute('data-research');
      const team = (who==='home') ? g.home : g.away;
      const opp  = (who==='home') ? g.away : g.home;
      window.openTeamResearch?.({ team, opponent: opp, week: CURRENT_WEEK, game: g });
    });
  });

  // admin: freeze single game by clicking badge
  const badge = tr.querySelector('[data-freeze]');
  if (USERNAME === 'Will' && badge && !g.spread_is_frozen){
    badge.style.cursor='pointer';
    badge.title='Click to freeze this line';
    badge.addEventListener('click', async ()=>{
      try{ await sbFreezeGame(g.id); await render(); }
      catch(e){ console.error('freeze', e); if (typeof showToast==='function') showToast('Freeze failed'); }
    });
  }

  // initial tint
  tintPickCell(teamSel, g);
}

function sortRows(mode){
  const tbody = document.getElementById('picks-body');
  const rows = Array.from(tbody.querySelectorAll('tr[data-game-id]'));
  if (mode === 'conf'){
    rows.sort((a,b)=>{
      const ca = Number(a.querySelector('.conf-select')?.value || '-9999');
      const cb = Number(b.querySelector('.conf-select')?.value || '-9999');
      // desc by confidence; blank to bottom; then kickoff time asc
      if (cb !== ca){
        if (isNaN(ca)) return 1;
        if (isNaN(cb)) return -1;
        return cb - ca;
      }
      const ta = Number(a.dataset.commence || a.getAttribute('data-commence') || '0');
      const tb = Number(b.dataset.commence || b.getAttribute('data-commence') || '0');
      return ta - tb;
    });
  } else {
    rows.sort((a,b)=>{
      const ta = Number(a.dataset.commence || a.getAttribute('data-commence') || '0');
      const tb = Number(b.dataset.commence || b.getAttribute('data-commence') || '0');
      return ta - tb;
    });
  }
  rows.forEach(r=>tbody.appendChild(r));
}

async function render(){
  locked  = await sbLoadWeekLock(CURRENT_WEEK);
  games   = await sbLoadGames(CURRENT_WEEK);
  myPicks = await sbLoadMyPicks(CURRENT_WEEK);

  usedConfidence = new Set(
    Object.values(myPicks)
      .map(p => (p.confidence != null ? Number(p.confidence) : undefined))
      .filter(v => v != null)
  );

  const tbody = document.getElementById('picks-body');
  tbody.innerHTML = '';

  const pool = confPoolFor(games.length);
  games.forEach(g=>{
    tbody.insertAdjacentHTML('beforeend', rowHtml(g, pool));
    attachRowHandlers(tbody.lastElementChild, g);
  });

  sortRows(document.getElementById('sortMode').value);
  updatePartialBanner();
}

/* -------------------------------------------------------------
   Init
------------------------------------------------------------- */
async function init(){
  // Resolve link token -> username, else localStorage/CONFIG
  const t = new URLSearchParams(location.search).get('t');
  if (t){
    try{
      const res = await sbResolveLink(t);
      if(res?.username){ setUsername(res.username); localStorage.setItem('username', res.username); history.replaceState({},'',location.pathname); }
    }catch(e){ console.error('resolve-link', e); }
  }
  if (!USERNAME){
    const u = localStorage.getItem('username') || window.CONFIG.USERNAME || '';
    if (u) setUsername(u);
  }

  // Week select
  const weeks = await sbLoadWeeks();
  const sel = document.getElementById('week-select');
  sel.innerHTML = '';
  weeks.forEach(w=>{
    const o = document.createElement('option');
    o.value = w.week;
    o.textContent = 'Week ' + w.week;
    sel.appendChild(o);
  });
  const maybeDefault = await sbGetCurrentWeek().catch(()=>null);
  const candidate = Number(maybeDefault);
  CURRENT_WEEK = (Number.isFinite(candidate) && weeks.some(w => Number(w.week)===candidate))
    ? candidate
    : (weeks[0]?.week || 1);
  sel.value = CURRENT_WEEK;

  sel.onchange = ()=>{ CURRENT_WEEK = Number(sel.value); render(); };
  document.getElementById('sortMode').onchange = ()=> sortRows(document.getElementById('sortMode').value);

  // Admin buttons
  document.getElementById('btn-lock').onclick        = async ()=>{ await adminLock(CURRENT_WEEK,'lock');   await render(); };
  document.getElementById('btn-unlock').onclick      = async ()=>{ await adminLock(CURRENT_WEEK,'unlock'); await render(); };
  document.getElementById('btn-freeze-week').onclick = async ()=>{ await sbFreezeWeek(CURRENT_WEEK);       await render(); };
  document.getElementById('btn-default-week').onclick= async ()=>{
    try{ await sbSetCurrentWeek(CURRENT_WEEK); showToast?.(`Default week set to ${CURRENT_WEEK}`); }catch(e){ console.error(e); }
  };
  document.getElementById('btn-pull-scores').onclick = async ()=>{
    try{ const r = await sbPullScoresNow(CURRENT_WEEK); showToast?.(r?.message || 'Scores pulled.'); await render(); }catch(e){ console.error(e); showToast?.('Pull scores failed.'); }
  };

  initSaveFlow();
  await render();
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
